<!DOCTYPE html>
<html lang="cn">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>2018 浦东唐城世界9球中国公开赛赛事日程</title>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<!--<script src="mdata.js" type="text/javascript"></script>-->
		<!-- Bootstrap -->
		<link href="css/bootstrap.min.css" rel="stylesheet">	
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="jquery-3.3.1.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.bundle.js"></script>
		<!--<script src="js/bootstrap.min.js"></script>-->		

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		  <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
		  <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body style="padding: 0px 0px;">	<!--if use tab nav, should have padding on top-->	
		<nav>
			<div class="nav nav-tabs navbar-expand-sm navbar-light" id="main-nav-tab" role="tablist" >
				<a class="nav-item nav-link active" id="nav-before-tab" data-toggle="tab" href="#nav-before" role="tab" aria-controls="nav-before" aria-selected="true" >男子 Men</a>
				<a class="nav-item nav-link" id="nav-in-tab" data-toggle="tab" href="#nav-in" role="tab" aria-controls="nav-in" aria-selected="false">女子 Women</a>				
			</div>
		</nav>		
		<div class="tab-content" id="nav-tabContent">
			<div class="tab-pane active" id="nav-before" role="tabpanel" aria-labelledby="nav-before-tab">				
				<div class="container-fluid">
					<div class="row">					
						<div class="col-md-4">							
						</div>					
						<div class="col-md-4">
							<button id="ajaxReq" class="btn btn-warning btn-block" type="button">刷新数据Refresh</button>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					<div class="row">
						<div class="col-md-4">
						</div>					
						<div class="col-md-4">
						  <!-- <form> -->							
								
								<input type="input" class="form-control" id="input-search" placeholder="搜索球员 Type to search player..." value="">							
							
							<button type="button" class="btn btn-outline-success" id="btn-search">搜索Search</button>
							<button type="button" class="btn btn-outline-secondary" id="btn-clear-search">清除Clear</button>
							            
						  <!-- </form> -->		  
						</div>
						<div class="col-md-4">
						</div>
					</div>	
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div class="col-md-4">
							<span class="badge badge-light">时间段Session</span>
							<select id="msessionSel" name="msessionSel" class="selectpicker">								
							</select>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					<div class="row">
					<div class="col-md-4">							
						</div>
						<div class="col-md-4">
						<span class="badge badge-light">阶 段 G r o u p </span>
						<select id = "mgroupSel" name="mgroupSel" class="selectpicker"></select>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div id="cardListMatch" class="col-md-4">						
						</div>
						<div class="col-md-4">							
						</div>
					</div>						
					
				</div>
			</div>	
			<div class="tab-pane fade" id="nav-in" role="tabpanel" aria-labelledby="nav-in-tab">				
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div class="col-md-4">
							<button id="ajaxReq" class="btn btn-warning btn-block" type="button">刷新数据Refresh</button>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					<div class="row">
						<div class="col-md-4">
						</div>					
						<div class="col-md-4">
						  <!-- <form> -->							
							
							  <input type="input" class="form-control" id="input-search2" placeholder="搜索球员 Type to search player..." value="">							
							
							<button type="button" class="btn btn-outline-success" id="btn-search2">搜索Search</button>
							<button type="button" class="btn btn-outline-secondary" id="btn-clear-search2">清除Clear</button>
							
						  <!-- </form> -->		  
						</div>
						<div class="col-md-4">
						</div>
					</div>	
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div class="col-md-4">
							<span class="badge badge-light">时间段Session</span>
							<select id="wsessionSel" name="wsessionSel" class="selectpicker">								
							</select>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div class="col-md-4">
						<span class="badge badge-light">阶段 Group</span>
						<select id = "wgroupSel" name="wgroupSel" class="selectpicker"></select>
						</div>
						<div class="col-md-4">							
						</div>
					</div>
					
					<div class="row">
						<div class="col-md-4">							
						</div>
						<div id="cardListMatchW" class="col-md-4">						
						</div>
						<div class="col-md-4">							
						</div>
					</div>
				</div>	
			</div>
			
		</div>
	</body>	
	<script>
	
	
var g_all_text = "所有 All";
var g_unschedule = "未定 unsheduled";
var g_matches = [];
var g_matches2 = [];
var g_g;

//get parameters from url
function getUrlVars(){
	var vars = [], hash;
	var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	for (var i = 0; i < hashes.length; i++) {
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}
	return vars;
}

//ajax way to reload data in pages
$(document).ready(function(){
	g_g = String(getUrlVars()["g"]).toUpperCase();
	main(g_g);
	$("button#ajaxReq").click(function(){
		LoadData(g_g, false);
		/*
		$.ajax({url:"mdata.js" + "?v=" + Math.random(),async:true,success:function(result){			
			FilterMatches("M");
			FilterMatches("W");			
		}});
		*/
	});
});

function main(g){
	LoadData(g, true);
}

function LoadData(g, restart){
	if (g == ""){		
		$.ajax({url:"mdata.js" + "?v=" + Math.random(),async:true,success:function(result){
			g_matches = [];
			g_matches2 = []
			LoadDataToArray(GetMatchDataObj(), g_matches, "M", g);
			LoadDataToArray(GetMatchDataObj(), g_matches2, "W", g);
			if (restart){
				LoadFilters(g_matches, "M", $("select#msessionSel"), $("select#mgroupSel"));
				LoadFilters(g_matches2, "W", $("select#wsessionSel"), $("select#wgroupSel"));
			}			
			FilterMatches("M");
			FilterMatches("W");			
		}});
	}
	else{		
		$.ajax({url:"pmdata.js" + "?v=" + Math.random(),async:true,success:function(result){
			g_matches = [];			
			LoadDataToArray(GetMatchDataObj(), g_matches, "M", g);
			if (restart)
				LoadFilters(g_matches, "M", $("select#msessionSel"), $("select#mgroupSel"));			
			//LoadManMatches("","");
			FilterMatches("M");			
		}});
		
		$.ajax({url:"pwdata.js" + "?v=" + Math.random(),async:true,success:function(result){
			LoadDataToArray(GetMatchDataObj(), g_matches2, "W", g);
			if (restart)
				LoadFilters(g_matches2, "W", $("select#wsessionSel"), $("select#wgroupSel"));
			//LoadWomanMatches("","");			
			FilterMatches("W");			
		}});
	}	
}

function LoadDataToArray(dataObj, arrMatch, s, g){
	dataObj.forEach(function(e){
		if (s === e.S && ( g === "" || g === e.G)){			
			arrMatch.push(e);
		}		
	});	
}

//sf is session filter, gf is group filter
function LoadManMatches(sf, gf, nf){	
	LoadMatchesIntoTab(g_matches, $("div#cardListMatch"), "M", sf, gf, nf);
}

function LoadWomanMatches(sf, gf, nf){	
	LoadMatchesIntoTab(g_matches2, $("div#cardListMatchW"), "W", sf, gf, nf);
}

function GetMatchDataObj(){
	var m = matches;
	return m;
}

function IsPreliminary(){
	return (g_g >= "P" && g_g <="U");
}

//flag "M" or "W"
function LoadFilters(matchObj, flag, sessionSel, groupSel){
	var sessions = new Map();
	var groups = new Map();
	var rounds = new Map();
	var roundsval = new Map();
	
	for (var i = 0; i < matchObj.length; i++){		
		var k = matchObj[i].Session
		var e = matchObj[i].Date + " " + matchObj[i].Time;
		
		//unscheduled time
		if (k == ""){
			k = "unscheduled";
			e = g_unschedule;
		}
		
		if (matchObj[i].S == flag && !sessions.has(k))
			sessions.set(k, e);
		
		var g = matchObj[i].G;
				
		if (matchObj[i].S == flag && !groups.has(g))
			groups.set(g, matchObj[i].GN);
			
		if (matchObj[i].S == flag && !rounds.has(matchObj[i].DES)){
			roundsval.set(parseInt(matchObj[i].N), matchObj[i].DES);
			rounds.set(matchObj[i].DES, "");
		}
	}
	
	var items1 = Array.from(sessions.values());
	var items2 = Array.from(groups.values());
	items1.sort();
	items2.sort();
	
	var keys3 = Array.from(roundsval.keys());
	keys3.sort(function(a,b){
		return parseInt(a) - parseInt(b);
	});
	
	var items3 = [];
	keys3.forEach(function(e){
		items3.push(roundsval.get(e));
	})
	
	sessionSel.append($("<option></option>").text(g_all_text));
	for (var value of items1) {
		var opt = $("<option></option>").text(value);
		sessionSel.append(opt);
	}
	
	if (IsPreliminary()){
		groupSel.append($("<option></option>").text(g_all_text));
		for (var value of items3) {
			var opt = $("<option></option>").text(value);
			groupSel.append(opt);
		}
	}
	else{
		groupSel.append($("<option></option>").text(g_all_text));
		for (var value of items2) {
			var opt = $("<option></option>").text(value);
			groupSel.append(opt);
		}
	}	
}

$("select#msessionSel").change(
	function(){		
		FilterMatches("M");
		
	}
)

$("select#mgroupSel").change(
	function(){		
		FilterMatches("M");		
	}
)

$("select#wsessionSel").change(
	function(){		
		FilterMatches("W");
		
	}
)

$("select#wgroupSel").change(
	function(){		
		FilterMatches("W");		
	}
)

function FilterMatches(m){
	var sf, gf;
	
	if (m == "M"){
		sf = $("select#msessionSel").find("option:selected").text();
		gf = $("select#mgroupSel").find("option:selected").text();
		if (sf == g_all_text) sf = "";
		if (gf == g_all_text) gf = "";
		LoadManMatches(sf, gf, $('#input-search').val());
	}
	else{
		sf = $("select#wsessionSel").find("option:selected").text();
		gf = $("select#wgroupSel").find("option:selected").text();
		if (sf == g_all_text) sf = "";
		if (gf == g_all_text) gf = "";
		LoadWomanMatches(sf, gf, $('#input-search2').val());
	}
}

function GetKey(m){
	var g = m.G;
	if (g == "")
		g = "Z";
		
	return m.Session + m.S + g + pad(m.N, 4);
}


function pad(num, n) {
    var len = num.toString().length;
    while(len < n) {
        num = "0" + num;
        len++;
    }
    return num;
}


function LoadMatchesIntoTab(matchObj, table, gender, sf, gf, nf){
	//alert("load players");
	table.empty();
	
	var mm = new Map();
	for (var i = 0; i < matchObj.length; i++){
		if (gender != ""){
			if (gender != matchObj[i].S)
				continue;
		}
		
		if (sf != ""){
			if (sf == g_unschedule){
				if (matchObj[i].Date != "" && matchObj[i].Time != "")
					continue;
			}
			else if (sf != matchObj[i].Date + " " + matchObj[i].Time){
				continue;
			}
		}
		
		if (gf != ""){
			if (IsPreliminary()){
				if (gf != matchObj[i].DES)
					continue;
			}
			else{
				if (gf != matchObj[i].GN)
					continue;
			}			
		}

			
		if (nf != ""){
			if (matchObj[i].P1.toUpperCase().indexOf(nf.toUpperCase()) === -1 && matchObj[i].P2.toUpperCase().indexOf(nf.toUpperCase()) === -1)
				continue;
		}	
		mm.set(GetKey(matchObj[i]), matchObj[i]);
	}
	
	var keys = Array.from(mm.keys())
	keys.sort();
	
	for (var i = 0; i < keys.length; i++){
		var div = $("<div class=\"card\" style=\"padding: 2px;margin: 2px;\"></div>");	
		var div2 = $("<div class=\"card-body\" style=\"padding: 0px;\"></div>");
		var item = mm.get(keys[i]);
		
		var tx1 = item.ID + " " + item.Date + " " + item.Time + " " + item.DES;
		if (item.Table != "") tx1 += (" T:" + item.Table);
		
		
		var tx2, tx3;
		if (item.S1 == "")
			tx2 = " " + " - " + item.P1;
		else
			tx2 = item.S1 + " - " + item.P1;
		
		if (item.S2 == "")
			tx3 = " " + " - " + item.P2;
		else
			tx3 = item.S2 + " - " + item.P2;
		
		
		
		div.append($("<h6 style=\"padding: 2px;font-size: 0.95rem\" class=\"card-title bg-light\"></h6>").text(tx1));
		div.append($("<p style=\"padding: 0px; font-size: 0.95rem\" class=\"card-subtitle mb-2 text-muted\"></p>").text(tx2));
		div.append($("<p style=\"padding: 0px; font-size: 0.95rem\" class=\"card-subtitle mb-2 text-muted\"></p>").text(tx3));
		div.append(div2);
		table.append(div);		
	}
}




$('#btn-search').on('click', function(){FilterMatches("M")});
$('#input-search').on('keydown', function(e){
	if (e.keyCode == 13)
		FilterMatches("M");
});

$('#btn-clear-search').on('click', function (e) {    
    $('#input-search').val('');
	FilterMatches("M");
});


$('#btn-search2').on('click', function(){FilterMatches("W")});
$('#input-search2').on('keydown', function(e){
	if (e.keyCode == 13)
		FilterMatches("W");
});

$('#btn-clear-search2').on('click', function (e) {    
    $('#input-search2').val('');
	FilterMatches("W");
});

	</script>
</html>